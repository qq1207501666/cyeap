<!-- 套用基础模版页面 START-->
{% extends "base.html" %}
<!-- 套用基础模版页面 END-->
<!-- 填充内容栏 page-content START-->
{% block page-content %}
    <!-- 搜索栏 START-->
    <div class="container-fluid panel panel-default">
        <div class="row panel-body">
            <div class="col-md-3">
                <div class="input-group">
                    <div class="input-group-addon">名称</div>
                    <input type="text" class="form-control" name="input_tomcat_name">
                </div>
            </div>
            <div class="col-md-3">
                <div class="input-group">
                    <div class="input-group-addon">别名</div>
                    <input type="text" class="form-control" name="input_tomcat_alias">
                </div>
            </div>
            <div class="col-md-3">
                <div class="input-group">
                    <div class="input-group-addon">内网IP</div>
                    <input type="text" class="form-control" name="input_ip4_inner">
                </div>
            </div>
            <div class="col-md-3">
                <div class="input-group">
                    <div class="input-group-addon">应用名称</div>
                    <input type="text" class="form-control" name="input_webapp_name">
                </div>
            </div>
        </div>
    </div>
    <!-- 搜索栏 END-->
    <hr/>
    <!-- 表格数据展示 START -->
    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead>
            <tr>
                <th>#</th>
                <th>Tomcat目录名称</th>
                <th>别名</th>
                <th>内网IP</th>
                <th>Tomcat部署路径</th>
                <th>应用程序部署路径</th>
                <th>状态</th>
                <th>操作</th>
                <th>备注</th>
            </tr>
            </thead>
            <tbody>
            <!-- 通过 AJAX 获取数据进行填充 -->
            </tbody>
        </table>
    </div>
    <!-- 表格数据展示 END -->
    <!-- 底部分页页码 START -->
    <nav class="page-header" aria-label="Page navigation">
        <!-- 通过 AJAX 获取数据进行填充 -->
    </nav>
    <!-- 底部分页页码 END -->
{% endblock %}
<!-- 填充内容栏 page-content END-->
<!-- 本页面的js脚本 START-->
{% block script %}
    <script>
        $(function () {
            /* --------------------函数定义区 START--------------------------*/
            /* 返回查询数据所用到的字典参数*/
            function get_params() {
                var tomcat_name = $('input[name="input_tomcat_name"]').val();
                var tomcat_alias = $('input[name="input_tomcat_alias').val();
                var ip4_inner = $('input[name="input_ip4_inner').val();
                var webapp_name = $('input[name="input_webapp_name').val();
                var params = {
                    "tomcat_name": tomcat_name,
                    "tomcat_alias": tomcat_alias,
                    "ip4_inner": ip4_inner,
                    "webapp_name": webapp_name,
                    "page_num": 1,  // 默认显示第一页
                    "page_size": 5  // 默认单页条数
                };
                return params;
            }

            /* 获取表格中数据的函数 */
            function get_tomcat_server(action, params) {
                $.get(action, {params: JSON.stringify(params)}, function (data) {
                    var tbody_html = "";
                    for (tm in data) { //遍历数据
                        if (!isNaN(tm)) {
                            // 拼接table.tbody html
                            tbody_html += "<tr>";
                            tbody_html += "<td><input type=\"checkbox\" name=\"tomcat_id\" value=\"" + data[tm]["id"] + "\"></td>";
                            tbody_html += "<td>" + data[tm]["name"] + "</td>";
                            tbody_html += "<td>" + data[tm]["alias"] + "</td>";
                            tbody_html += "<td>" + data[tm]["ip4_inner"] + "</td>";
                            tbody_html += "<td>" + data[tm]["deploy_path"] + "</td>";
                            tbody_html += "<td>" + data[tm]["webapp_deploy_path"] + "</td>";
                            if (data[tm]["is_run"]) {
                                tbody_html += "<td><input id=\"stop_tomcat\" type=\"button\" class=\"btn btn-success btn-xs\" data-toggle=\"tooltip\" title=\"点击停止运行\" value=\"运行中\"></td>";
                            } else {
                                tbody_html += "<td><input id=\"start_tomcat\" type=\"button\" class=\"btn btn-danger btn-xs\" data-toggle=\"tooltip\" title=\"点击启动服务\" value=\"已停止\"></td>";
                            }
                            tbody_html += "<td><img src=\"/static/img/upgrade.ico\" data-toggle=\"tooltip\" title=\"升级\"/></td>";
                            tbody_html += "<td><img src=\"/static/img/remark.ico\" data-toggle=\"tooltip\" title=\"" + data[tm]["remark"] + "\"/></td>"
                        }
                    }
                    $("tbody").html(tbody_html); // 替换表格中的 html
                    $(".page-header").html(data["page_html"]); // 替换底部页码 html
                })
            }

            /* 翻页函数 */
            function flip_page(flag) {
                var params = get_params();
                var page_num = $(".pagination .active a").html();  // 获取当前页码
                if (flag == "previous_page") {
                    page_num--;
                    if (page_num == 0 || isNaN(page_num)) {
                        page_num = 1;
                    }
                } else if (flag == "next_page") {
                    page_num++;
                    if (isNaN(page_num)) {
                        page_num = 99999;
                    }
                } else {
                    page_num = $(flag).html();  // 获取点击的页码,要参数转成jquery对象才能使用.html()
                }
                params["page_num"] = page_num; // 改变页码条件
                get_tomcat_server(action, params); // 获取数据
            }

            /* --------------------函数定义区 END ---------------------------*/
            /* -------------------------------------START-------------------------------------*/
            $("#nav_cyeap_tomcat").addClass("active"); // 激活导航栏样式
            var action = "/cyeap_tomcat/get_tomcat_server"; // 获取数据 url 地址
            var params = get_params();   // 获取参数
            get_tomcat_server(action, params); //初始化数据
            /* 页面事件绑定 START */
            // 查询事件,搜索框内容改变时触发
            $("input[type=text]").on("input", function () {
                params = get_params(); // 获取参数
                get_tomcat_server(action, params); // 获取数据
            });
            // 启动Tomcat服务
            $(document).on('click', '#start_tomcat', function () {

            });
            // 停止Tomcat服务
            $(document).on('click', '#stop_tomcat', function () {

            });
            // 升级项目
            $(document).on('click', 'img[title=\'升级\']', function () {
                var action = "/cyeap_tomcat/upgrade_webapp/"; // 获取数据 url 地址
                var tomcat_id = $(this).parent().siblings().eq(0).children().val();  // 获取 TomcatID
                var params = {"tomcat_id": tomcat_id};
                $.post(action, {params: JSON.stringify(params)}, function (data) {
                    console.log(data["result"]);
                });
            });
            // 上一页事件
            $(document).on('click', '#previous_page', function () {
                flip_page("previous_page");
            });
            // 下一页事件
            $(document).on('click', '#next_page', function () {
                flip_page("next_page");
            });
            // 跳页事件
            $(document).on('click', '.pagination li .page_num', function () {
                flip_page(this);
            });
            /* 页面事件绑定 END */
            /* ------------------------------------- END -------------------------------------*/
        });

    </script>
{% endblock %}
<!-- 本页面的js脚本 END-->







